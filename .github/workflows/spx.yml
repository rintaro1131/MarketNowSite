name: Update SPX cache
on:
  workflow_dispatch:
  schedule:
    # 平日9:00-23:00 JSTをざっくりカバー（UTCで毎時25分）
    - cron: '25 * * * 1-5'
jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Fetch SPX from Stooq via proxy
        id: get
        run: |
          set -e
          URL="https://r.jina.ai/https://stooq.com/q/d/l/?s=%255Espx&i=d"
          TXT="$(curl -fsSL --max-time 15 "$URL")"
          LINE="$(printf '%s\n' "$TXT" | tail -n1)"
          DATE="$(echo "$LINE" | awk -F, '{print $1}')"
          CLOSE="$(echo "$LINE" | awk -F, '{print $5}')"
          if [ -z "$CLOSE" ] || ! echo "$CLOSE" | grep -Eq '^[0-9]+(\.[0-9]+)?$'; then
            # フォールバック（q/l 形式）
            URL2="https://r.jina.ai/https://stooq.com/q/l/?s=%255Espx&i="
            TXT2="$(curl -fsSL --max-time 15 "$URL2")"
            CLOSE="$(printf '%s\n' "$TXT2" | tail -n1 | awk -F, '{print $2}')"
          fi
          echo "close=$CLOSE" >> $GITHUB_OUTPUT
          echo "date=$DATE"   >> $GITHUB_OUTPUT
      - name: Write JSON
        run: |
          mkdir -p data
          printf '{ "value": %s, "date": "%s", "source": "stooq-proxy" }\n' "${{ steps.get.outputs.close }}" "${{ steps.get.outputs.date }}" > data/spx.json
      - name: Commit & Push
        run: |
          git config user.name  "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add data/spx.json
          git commit -m "chore: update spx cache ($(date -u +'%Y-%m-%dT%H:%M:%SZ'))" || exit 0
          git push

